#!/usr/bin/env bash

set -Cue -o pipefail

HOST="$1" ; shift
SSH_CONTROL_PERSIST="${SSH_CONTROL_PERSIST:-2s}"
TMP_DIR="${TMP_DIR:-/tmp}"

remote_dir="dos"
control_path="${TMP_DIR}/.$(uuidgen).tmp"
cmd_1="""
mkdir -p \"${remote_dir}\" &&
tar -f - -C \"${remote_dir}\" -xz
"""
cmd_2="""
rm -f \"${remote_dir}/README.md\"
"""

cleanup() {
  ssh -O exit -oControlPath="$control_path" "$HOST" >/dev/null 2>&1
  rm -f "$control_path"
}

trap cleanup 0

tar -f - -cz . | ssh \
  -T \
  -oControlMaster=yes \
  -oControlPath="$control_path" \
  -oControlPersist="$SSH_CONTROL_PERSIST" \
  "$HOST" \
  "$cmd_1" \

ssh \
  -tt \
  -oControlPath="$control_path" \
  "$HOST" \
  "$cmd_2"
